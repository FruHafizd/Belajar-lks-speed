<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shooter</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        display: flex;
        align-items: center;
        height: 100vh;
        justify-content: center;
        font-family: Arial, Helvetica, sans-serif;
      }
      .container {
        width: 100%;
        height: 600px;
        max-width: 1000px;
        border: 1px solid black;
        display: flex;
        grid-template-columns: 1fr 1fr;
        justify-content: center;
        align-items: center;
        padding: 2rem;
        gap: 4rem;
      }
      
      .welcome img {
        width: 75px;
      }
      
      #level{
        width: 250px;
        padding: 10px;
        border-radius: 5px;
        background: rgb(243, 239, 239);
        color: gray; 
        border: gray 1px solid;
      }
      
      #sort{
        width: 210px;
        padding: 10px;
        color: brown;
        font-weight: bold;
        border-radius: 5px;
        background: rgb(243, 239, 239);
        color: gray; 
        border: gray 1px solid;
      }
      
      #input{
        width: 250px;
        height: 40px;
        padding: 10px;
        border-radius: 5px;
        background: rgb(243, 239, 239); 
        color: gray;
        border: gray 1px solid;
        padding-bottom: 5px;
      }
      
      .container .logo {
        width: 200px;
      }
      
      .logo{
        width: 180px !important;
      }
      
      .welcome {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 1rem;
      }
      
      .game {
        position: relative;
        border: 1px solid red;
        width: 100%;
        max-width: 1000px;
        height: 600px;
        display: grid;
        grid-template-columns: 750px auto;
        border: 2px solid black;
      }
      
      .leaderboard {
        padding: 1rem;
        width: 100%;
        background: black;
        color: silver;
        display: flex;
        flex-direction: column;
        align-items: center;
        overflow-y: auto;
        gap: 0.75rem;
      }
      
      .body {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        overflow-y: auto;
        width: 100%;
      }
      
      .item {
        display: grid;
        grid-template: 1fr/2fr 1fr;
        width: 100%;
        gap: 0.5rem;
      }
      
       .detail {
        width: 120px;
      }
      
      .board {
        background-image: url("Sprites/background.jpg");
        background-size: cover;
        background-position: center;
        position: relative;
        overflow: hidden;
        border: 2px solid green;
      }
      
      .board > * {
        transition: opacity 0.2s ease;
        position: absolute;
      }
      .target {
        transition: all 0.2s ease-in;
        opacity: 1;
      }
      .remove {
        opacity: 0;
      }
      .pointer,
      .gun {
        transition: transform 0.2s ease;
        z-index: 999;
      }
      .gun {
        width: 200px;
      }
      .header {
        z-index: 9999;
        width: 100%;
        height: 50px;
        background-color: rgba(0, 0, 0, 0.35);
        color: white;
        font-size: 1.5rem;
        display: flex;
        padding: 0 1rem;
        justify-content: space-between;
        align-items: center;
      }
      .up {
        transform: translateY(200px);
      }
      .count {
        left: 50%;
        top: 50%;
        z-index: 9999;
        font-size: 4rem;
      }
      
      .bg {
        display: flex;
        justify-content: center;
        align-items: center;
        position: absolute;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.575);
        z-index: 99999;
      }
      .bg:has(.hide) {
        display: none;
      }
      
      .choices{
        display: flex;
        gap: 15px; 
      }
      
      .target1, .target2, .target3, .gun1, .gun2{
        display: flex;
        gap: 10px;
        flex-direction: column;
      } 
      
      .alert {
        background: white;
        display: flex;
        padding: 4rem;
        border-radius: 1rem;
        border: 2px solid black;
        flex-direction: column;
        gap: 0.5rem;
      }
      
      #btn-board{
        width: 120px;
        background: rgb(229, 229, 71);
        border: none;
        border-radius: 5px;
        font-weight: bold;
      }
      
      
      
      .close {
        position: absolute;
        color: red;
        font-weight: bold;
        cursor: pointer;
        right: 1rem;
        top: 1rem;
        padding-top: 5px;
      }
      .hide {
        display: none !important;
      }
      .instructBoard {
        border-radius: 5px;
        position: relative;
        height: 500px;
        width: 400px;
        background-color: rgb(68, 41, 41);
        animation-name: show;
        animation-duration: 1s;
      }
      
      .text-plain{
        padding: 20px 20px; 
        color: white;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      button{
        width: 120px;
        padding: 10px; 
        border: none;
        border-radius: 5px;
        font-weight: bold;
      }
      
      
      #playButton{
        background-color: rgb(59, 180, 59);
        color: white; 
      }
      
      .main-menu{
       width: max-content;
       border: 1px solid red;
      }
      
      .instruction{
        background-color:rgb(68, 41, 41); 
        color: white;
      }
      
      .board-item{
        display: flex;
        gap: 5px; 
      }
      
      .user-text{
        flex-basis: 90%;
      }
      .btn-text{
        flex-basis: 10%;
      }
      
      #detail {
        height: 100%; 
        background-color: brown;
        color: white;
      }
      
      @keyframes show {
        0% {
          opacity: 0.1;
        }
        12.5% {
          opacity: 0.25;
        }
        25% {
          opacity: 0.4;
        }
        37.5% {
          opacity: 0.55;
        }
        50% {
          opacity: 0.7;
        }
        62.5% {
          opacity: 0.85;
        }
        75% {
          opacity: 0.9;
        }
        87.5% {
          opacity: 0.95;
        }
        100% {
          opacity: 1;
        }
      }
      
    </style>
  </head>

  <body>
    <div class="container">
      <div class="welcome">
        <img src="Sprites/shooter.png" alt="" class="logo" />
        <input
          type="text"
          placeholder="Input username"
          name="name"
          id="input"
          required
        />
        <select name="level" id="level" required>
          <option value="" disabled selected>Select Level</option>
          <option value="30">Easy</option>
          <option value="20">Medium</option>
          <option value="15">Hard</option>
        </select>
        <div class="choices">
          <label class="gun1">
            <img src="Sprites/gun1.png" alt="" />
            <input type="radio" name="gun" id="gun1" value="true" required />
          </label>
          <label class="gun2">
            <img src="Sprites/gun2.png" alt="" />
            <input type="radio" name="gun" id="gun2" value="false" required />
          </label>
        </div>
        <div class="choices">
          <div class="target1">
            <img src="Sprites/target1.png" alt="" />
            <input type="radio" name="target" value="1" id="target1" required />
          </div>
          <div class="target2">
            <img src="Sprites/target2.png" alt="" />
            <input type="radio" name="target" value="2" id="target2" required />
          </div>
          <div class="target3">
            <img src="Sprites/target3.png" alt="" />
            <input type="radio" name="target" value="3" id="target3" required />
          </div>
        </div>

       
        <div class="choices">
          <button class="play" onclick="play()" id="playButton" disabled>
            Play Game
          </button>
          <button class="instruction" onclick="showInstruction()">
            Instruction
          </button>
        </div>

        <div class="show-error hide">
          <small style="color: red;">Fill all the form before play the game!</small>
        </div>

      </div>
      <div class="instructBoard hide">
        <div class="text-plain">
          <h2>How to play game</h2>
          <p>1. Input username</p>
          <p>2. Point the pointer at the target</p>
          <p>3. Click to shoot</p>
          <p>4. Get as many points as possible</p>
          <p>5. Enjoy!</p>
        </div>
        <div
          class="close"
          onclick="document.querySelector('.instructBoard').classList.add('hide');"
        >
          ‚ùå
        </div>
      </div>
    </div>
    <div class="game hide">
      <div class="bg">
        <div class="alert hide" id="pause">
          <h2>Game Paused</h2>
          <button onclick="togglePause()">Continue</button>
        </div>
      </div>
      <div class="bg">
        <div class="alert hide" id="gameOver">
          <h2>Game Over</h2>
          <p id="playerNameOver">Name</p>
          <p id="scoreOver">Score</p>
          <div class="choices">
            <button onclick="main()">Restart</button>
            <button id="saveScoreBtn">Save Score</button>
          </div>
        </div>
      </div>
      <div class="board">
        <div class="header">
          <span><b id="playerTxt">Player Name</b></span>
          <span><b id="scoreTxt">Score: 0</b></span>
          <span><b id="timeTxt">Time: 30</b></span>
        </div>
        <h1 class="count">3</h1>
        <img src="Sprites/pointer.png" alt="" class="pointer" />
        <img src="Sprites/gun1.png" alt=" " class="gun" />
      </div>
      <div class="leaderboard">
        <h2>Leaderboard</h2>
        <label for="sort"
          >
          <select name="sort" id="sort">
            <option selected disabled>Sort By</option>
            <option value="time">Last Match</option>
            <option value="score">Score</option>
          </select>
        </label>
        <div class="body" id="leaderboardSection" style="margin-top: 20px;"></div>
      </div>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const playButton = document.getElementById('playButton');
        const nameInput = document.querySelector('[name="name"]');
        const levelSelect = document.querySelector('[name="level"]');
        const gunRadios = document.querySelectorAll('[name="gun"]');
        const targetRadios = document.querySelectorAll('[name="target"]');
      
        function validateForm() {
          const nameValid = nameInput.value.trim() !== '';
          const levelValid = levelSelect.value !== '';
          const gunValid = Array.from(gunRadios).some(radio => radio.checked);
          const targetValid = Array.from(targetRadios).some(radio => radio.checked);
          
          playButton.disabled = !(nameValid && levelValid && gunValid && targetValid);
        }
      
        nameInput.addEventListener('input', validateForm);
        levelSelect.addEventListener('change', validateForm);
        gunRadios.forEach(radio => radio.addEventListener('change', validateForm));
        targetRadios.forEach(radio => radio.addEventListener('change', validateForm));
      });
      
      class Game {
        constructor() {
          this.clicked = false;
          this.countdown = 4;
          this.countdownInterval = null;
          this.score = 0;
          this.targetInterval = null;
          this.board = document.querySelector(".board");
          this.initialize();
        }
      
        initialize() {
          this.name = document.querySelector('[name="name"]')?.value || "Player";
          this.timer = parseInt(document.querySelector('[name="level"]')?.value) || 30;
          this.targetType = document.querySelector('[name="target"]:checked')?.value || 1;
          this.gunType = document.querySelector('[name="gun"]:checked')?.value == "true";
          const nameGun = this.gunType ? 'Sprites/gun1.png' : 'Sprites/gun2.png';
          this.board.innerHTML = `
            <div class="header">
              <span><b id="playerTxt">${this.name}</b></span>
              <span><b id="scoreTxt">Score: 0</b></span>
              <span><b id="timeTxt">Time: ${this.timer}</b></span>
            </div>
            <h1 class="count">3</h1>
            <img src="Sprites/pointer.png" alt="" class="pointer">
            <img src="${nameGun}" alt=" " class="gun">`;
          this.gun = document.querySelector(".gun");
          this.pointer = document.querySelector(".pointer");
          this.bound = this.board.getBoundingClientRect();
          this.target = document.querySelectorAll(".target");
          this.pointer.style.left = this.board.clientWidth / 2 + "px";
          this.pointer.style.top = this.board.clientHeight / 2 + "px";
          this.gun.style.left = parseInt(this.pointer.style.left) + 50 + "px";
          this.gun.style.top = parseInt(this.pointer.style.top) + 150 + "px";
          document.getElementById('saveScoreBtn').onclick = () => {
            this.saveLeaderboard(this.name, this.score);
          };
          this.board.onmousemove = (e) => {
            const x = e.clientX - this.bound.left;
            const y = e.clientY - this.bound.top;
            this.pointer.style.left = x - 25 + "px";
            this.pointer.style.top = y - 25 + "px";
            this.gun.style.left = parseInt(this.pointer.style.left) + 50 + "px";
          };
      
          window.onresize = (e) => {
            this.bound = this.board.getBoundingClientRect();
          };
      
          window.onkeydown = (e) => {
            if (e.code == "Escape") {
              const pause = document.getElementById('pause');
              // TODO : lanjutkan game
              if (!pause.classList.contains("hide")) {
                pause.classList.add("hide");
      
                this.targetInterval = setInterval(() => {
                  this.createTarget();
                }, 3000);
      
                this.interval = setInterval(() => {
                  this.timer -= 0.1;
                  document.getElementById('timeTxt').innerText = `Time: ${this.timer.toFixed(0)}`;
                  if (this.timer <= 0) {
                    this.endGame();
                  }
                }, 100);
      
                
               
              } else {
                // TODO : berhentikan game
                pause.classList.remove("hide");
                clearInterval(this.interval);
                clearInterval(this.targetInterval);
              }
            }
            if (e.code == "Space") {
              this.gunType = !this.gunType;
              this.gun.src = `Sprites/gun${this.gunType ? 1 : 2}.png`;
              this.gun.classList.add("up");
              setTimeout(() => {
                this.gun.classList.remove("up");
              }, 100);
            }
          };
        }
      
        generateTarget() {
          for (let i = 0; i < 3; i++) {
            this.createTarget();
          }
          this.target = document.querySelectorAll(".target");
        }
      
        start() {
          const countdownText = document.querySelector(".count");
          this.countdown = 3;
          countdownText.innerHTML = this.countdown;
          this.countdownInterval = setInterval(() => {
            this.countdown--;
            countdownText.innerHTML = this.countdown;
            if (this.countdown <= 0) {
              this.finishSetup();
              this.targetInterval = setInterval(() => {
                this.createTarget();
              }, 3000);
              countdownText.classList.add("hide");
              clearInterval(this.countdownInterval);
              this.interval = setInterval(() => {
                this.timer -= 0.1;
                document.getElementById('timeTxt').innerText = `Time: ${this.timer.toFixed(0)}`;
                if (this.timer <= 0) {
                  this.endGame();
                }
              }, 100);
            }
          }, 1000);
        }
      
        endGame() {
          clearInterval(this.interval);
          clearInterval(this.targetInterval);
          document.getElementById('gameOver').classList.remove("hide");
          document.getElementById('playerNameOver').innerText = 'Player Name : ' + this.name;
          document.getElementById('scoreOver').innerText = 'Score : ' + this.score;
        }
      
        finishSetup() {
          this.pointer.onclick = (e) => {
            const x = e.clientX - this.bound.left;
            const y = e.clientY - this.bound.top;
            let clicked = false;
            this.target.forEach((item) => {
              if (
                x < parseInt(item.style.left) + item.clientWidth &&
                x > parseInt(item.style.left) &&
                y < parseInt(item.style.top) + item.clientHeight &&
                y > parseInt(item.style.top)
              ) {
                if (!item.classList.contains("remove")) {
                  item.classList.add("remove");
                  this.score++;
                  document.getElementById('scoreTxt').innerText = `Score: ${this.score}`;
                  clicked = true;
                  // Menghapus target dari DOM setelah ditembak
                  setTimeout(() => {
                    item.remove();
                  }, 100);
                  return;
                }
              }
            });
            if (!clicked) {
              this.timer -= 5;
              document.getElementById('timeTxt').innerText = `Time: ${this.timer.toFixed(0)}`;
              if (this.timer <= 0) {
                this.endGame();
              }
            }
          };
        }
      
        createTarget() {
          const target = document.createElement("img");
          target.classList.add("target");
          target.src = `Sprites/target${this.targetType}.png`;
          target.width = '70'; 
          target.style.left = Math.random() * (this.board.clientWidth - 50) + "px";
          target.style.top = Math.random() * (this.board.clientHeight - 50) + "px";
          this.board.appendChild(target);
          this.target = document.querySelectorAll(".target"); 
        }
      
        saveLeaderboard(name, score) {
          const leader = JSON.parse(localStorage.getItem("leaderboard")) || [];
          leader.push({
            name,
            score,
            date: Date.now(),
          });
          localStorage.setItem("leaderboard", JSON.stringify(leader));
          this.fetchLeaderboard();
        }
      
        fetchLeaderboard() {
          let leader = JSON.parse(localStorage.getItem("leaderboard")) || [];
          const sortValue = document.getElementById('sort').value;
          if (sortValue === "score") {
            leader = leader.sort((a, b) => b.score - a.score);
          } else {
            leader = leader.sort((a, b) => b.date - a.date);
          }
          let html = "";
          leader.forEach((item) => {
            html += `
               <div class="board-item" style="margin-bottom:10px">
            <div class="user-text">
              <b>${item.name}</b>
              <p><i>Score : ${item.score}</i></p>
            </div>
            <div class="btn-item">
              <button style="padding: 2px;" id="detail">Detail</button>
            </div>
          </div>
            `;
          });
          document.getElementById('leaderboardSection').innerHTML = html;
        }
      }
      
      function main() {
        document.getElementById('gameOver').classList.add("hide");
        fetchLeaderboard();
        const game = new Game();
        game.generateTarget();
        game.start();
      }
      
      function play() {
        if (document.querySelector('input[name="name"]').value.trim() &&
          document.querySelector('select[name="level"]').value &&
          document.querySelector('input[name="gun"]:checked') &&
          document.querySelector('input[name="target"]:checked')) {
          document.querySelector(".container").classList.add("hide");
          document.querySelector(".game").classList.remove("hide");
          main();
        } else {
          alert('Please fill out all required fields.');
        }
      }
      
      function showInstruction() {
        document.querySelector(".instructBoard").classList.remove("hide");
      }
      
      document.getElementById('sort').onchange = (event) => {
        sortLeaderBoard(event.target.value); 
      };
      
      function sortLeaderBoard(value){
        let leader = JSON.parse(localStorage.getItem("leaderboard")) || [];
        const sortValue = value; 
      
        console.log(sortValue == "score");
      
        if (sortValue == "score") {
          leader.sort((a, b) => b.score - a.score);
        } else {
          leader.sort((a, b) => b.date - a.date);
        }
      
      
        let html = "";
        leader.forEach((item) => {
          html += `
             <div class="board-item" style="margin-bottom:10px">
                <div class="user-text">
                  <b>${item.name}</b>
                  <p><i>Score : ${item.score}</i></p>
                </div>
                <div class="btn-item">
                  <button style="padding: 2px;" id="detail">Detail</button>
                </div>
              </div>
          `;
        });
        document.getElementById('leaderboardSection').innerHTML = html;  
      }
      
      
      function fetchLeaderboard() {
        const game = new Game();
        game.fetchLeaderboard();
      }
      
      function togglePause() {
        const pause = document.getElementById('pause');
        if (!pause.classList.contains("hide")) {
          pause.classList.add("hide");
        } else {
          pause.classList.remove("hide");
        }
      }
      
    </script>
    <script src="main.js"></script>
  </body>
</html>